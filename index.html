<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>роЪроороиро┐ро▓рпИ роХрпВроЯрпНроЯрпБ ро░ро╛роЪро┐ роХроЯрпНроЯроорпН (108 рокро╛родроЩрпНроХро│рпН) & ро╡ро┐роорпНроЪрпЛродрпНродро░ро┐ родроЪрпИ тАФ Improved UI</title>
<style>
  :root{
    --bg:#fffef8;
    --card:#fffdf5;
    --ink:#15321a;
    --muted:#5c6b5f;
    --brand:#17671a;
    --brand-2:#2f76d2;
    --accent:#f20909;
    --border:#116504;
    --shadow:0 2px 6px rgba(0,0,0,.08);
    --ring:#a1c786;
  }
  [data-theme="dark"]{
    --bg:#0f1115;
    --card:#12161c;
    --ink:#e8f1ea;
    --muted:#a7b1aa;
    --brand:#63d96e;
    --brand-2:#7aa7ff;
    --accent:#ff8b8b;
    --border:#2a8a3b;
    --shadow:0 4px 12px rgba(0,0,0,.35);
    --ring:#2ea043;
  }

  *{box-sizing:border-box}
  body{font-family: system-ui, -apple-system, 'Noto Sans Tamil', Latha, Arial, sans-serif;
       background:var(--bg); color:var(--ink); margin:0; padding:18px}
  h2{margin:4px 0 16px; font-weight:800; letter-spacing:.2px}
  .appbar{position:sticky; top:0; z-index:50; background:var(--bg); padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06)}
  .barrow{display:flex; align-items:center; justify-content:space-between; max-width:1100px; margin:0 auto}
  .tag{padding:4px 10px; border:1.5px solid var(--ring); border-radius:999px; font-size:12.5px; color:var(--brand)}
  .theme-btn{border:1px solid var(--ring); background:transparent; color:var(--ink); border-radius:8px; padding:8px 12px; cursor:pointer}
  .wrap{max-width:1100px; margin:0 auto}

  /* cards & inputs */
  .card{background:var(--card); border:1.5px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:14px}
  .grid{display:grid; gap:14px}
  @media(min-width: 940px){ .grid-2{grid-template-columns:1.2fr .8fr} }

  label{font-size:.93rem; color:var(--muted); margin-right:8px}
  input[type="text"],input[type="date"],input[type="time"],input[type="number"],input[type="datetime-local"]{
    background:#fff; color:#111; border:1px solid #c6d4c8; border-radius:8px; padding:8px 10px; outline:none;
  }
  [data-theme="dark"] input{ background:#12161c; color:#e9efe8; border-color:#30423a }
  .btn{background:var(--brand-2); color:#fff; border:none; border-radius:10px; padding:9px 14px; cursor:pointer; font-weight:700}
  .btn:hover{filter:brightness(.95)}
  .btn:active{transform:translateY(1px)}
  .muted{color:var(--muted)}

  /* suggestions */
  .pos-relative{position:relative}
  #suggestions-box{position:absolute; top:100%; left:0; right:0; border:1px solid #aaa; background:var(--card);
    max-height:180px; overflow:auto; z-index:9999; display:none; font-size:.92em; border-radius:10px}
  #suggestions-box div{padding:8px 10px; cursor:pointer}
  #suggestions-box div:hover{background:rgba(46,160,67,.08)}

  /* chart */
  .south-chart{display:grid; grid-template-columns:repeat(4, 1fr); grid-template-areas:
    "r10  r11  r12  r01"
    "r09  photo  photo  r02"
    "r08  photo  photo  r03"
    "r07  r06  r05  r04";
    gap:8px; margin:0 auto 18px}
  @media(max-width: 920px){
    .south-chart{grid-template-columns:repeat(2,1fr); grid-template-areas:
      "r01 r02" "r03 r04" "r05 r06" "r07 r08" "r09 r10" "r11 r12" }
  }
  .box{background:var(--card); border:1.5px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
       color:var(--ink); padding:8px 6px; min-height:270px; display:flex; flex-direction:column}
  .rasi-name{font-weight:800; font-size:15px; color:var(--accent); text-align:center; margin-bottom:6px}
  .line{border-radius:6px; padding:4px 6px; margin:2px 0; line-height:1.45; font-size:.95rem}
  .line:hover{background:rgba(46,160,67,.08)}

  /* legend & status */
  .legend{position:sticky; top:64px; align-self:start}
  .pill{padding:5px 9px; border-radius:999px; font-weight:700; font-size:.85rem; display:inline-flex; gap:6px; align-items:center}
  .pill .dot{width:10px; height:10px; border-radius:50%}
  .pill.d{background:#e9ffe6; color:#17671a}
  .pill.p{background:#eafff2; color:#23985c}
  .pill.a{background:#f0fff5; color:#2b6f3a}
  [data-theme="dark"] .pill{filter:brightness(0.95)}

  /* highlights (greens) */
  .highlight-pada-dasa{background:#17671a !important; color:#fff !important; font-weight:800}
  .highlight-pada-puthi{background:#40be4a !important; color:#fff !important; font-weight:800}
  .highlight-pada-anthara{background:#b9f4ba !important; color:#21572a !important; font-weight:800}

  /* current box & tree */
  .currentbox{background:#e8ecf7; border-radius:12px; padding:14px 16px; box-shadow:var(--shadow); border:1px solid #cfd8ee}
  [data-theme="dark"] .currentbox{background:#141821; border-color:#2b3550}
  .dates{color:var(--muted); font-size:.9rem}

  .tree-ul{list-style:none; padding-left:20px; margin:6px 0}
  .tree-li{margin:6px 0}
  .tree-active{background:rgba(46,160,67,.08); border-radius:6px; padding:2px 4px}
  .tree-highlight-dasa{color:#17671a; font-weight:800}
  .tree-highlight-puthi{color:#40be4a; font-weight:800}
  .tree-highlight-anthara{color:#3b8733; font-weight:800}
  .tree-period{color:var(--muted); font-size:.92rem; margin-left:6px}
  .expand-btn{font-size:1.05em; font-weight:800; color:#1b5d1f; cursor:pointer; background:#ecefff; border:none;
              border-radius:6px; padding:0 7px; margin-right:6px}
  .expand-btn.expanded{background:#bffff1; color:#0cdd10}

  /* table */
  table{width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden}
  thead th{background:#f7fbf8; color:#17321c; border-bottom:1px solid #dfe8e3; padding:10px}
  [data-theme="dark"] thead th{background:#101820; color:#dfe8e3; border-color:#1e2a32}
  tbody td{border-bottom:1px dashed #e5eee8; padding:8px 10px}
  tbody tr:nth-child(odd){background:rgba(46,160,67,.03)}
  [data-theme="dark"] tbody tr:nth-child(odd){background:rgba(99,217,110,.06)}
  .export-bar{
  display:flex; align-items:center; justify-content:center; gap:10px;
  margin:10px auto 16px; flex-wrap:wrap; max-width:990px;
}
.export-bar select{ padding:6px 8px; border:1px solid #c8d4c8; border-radius:6px; }
.export-bar .btn-save{ background:#1b6e20; color:#fff; border:1px solid #0f5a14;
  border-radius:8px; padding:8px 14px; font-weight:600; cursor:pointer;
  box-shadow:0 1px 3px #00000014; transition:transform .06s ease, opacity .2s;
}
.export-bar .btn-save:hover{ transform:translateY(-1px); opacity:.95; }
  /* grid areas for rasis */
  .r01{grid-area:r11} .r02{grid-area:r12} .r03{grid-area:r01} .r04{grid-area:r02} .r05{grid-area:r03} .r06{grid-area:r04}
  .r07{grid-area:r05} .r08{grid-area:r06} .r09{grid-area:r07} .r10{grid-area:r08} .r11{grid-area:r09} .r12{grid-area:r10}
</style>
</head>
<body>
  <div class="appbar">
    <div class="barrow">
      <div>
        <h2>ЁЯМЯ <span style="color:#175397">Jps Astro Research</span> ЁЯМЯ</h2>
        <span class="tag"> ро░ро╛роЪро┐ (108 рокро╛родроЩрпНроХро│рпН) ┬╖ ро╡ро┐роорпНроЪрпЛродрпНродро░ро┐</span>
      </div>
      <button class="theme-btn" id="themeToggle" title="Light/Dark">ЁЯМУ</button>
    </div>
  </div>

  <div class="wrap grid grid-2">
    <!-- LEFT: forms + chart -->
    <div class="grid">
      <div class="card">
        <form id="astroForm" autocomplete="off">
          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:end">
            <div>
              <label for="dob_api">рокро┐ро▒роирпНрод родрпЗродро┐</label><br/>
              <input type="date" id="dob_api" required />
            </div>
            <div>
              <label for="tob_api">рокро┐ро▒роирпНрод роирпЗро░роорпН</label><br/>
              <input type="time" id="tob_api" required />
            </div>
            <div class="pos-relative" style="min-width:260px; flex:1">
              <label for="placeInput">рокро┐ро▒роирпНрод роЗроЯроорпН</label><br/>
              <input type="text" id="placeInput" placeholder="родрпКроЯроЩрпНроХрпБроЩрпНроХро│рпН..." required autocomplete="off" />
              <div id="suggestions-box"></div>
            </div>
            <div>
              <button class="btn" type="submit">API роорпВро▓роорпН роХрогроХрпНроХро┐роЯрпБ</button>
            </div>
          </div>
          <pre id="apiResult" class="muted" style="white-space:pre-wrap;margin-top:10px;"></pre>
        </form>
      </div>

      <div class="card">
        <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap">
          <div><label>рокро┐ро▒роирпНрод родрпЗродро┐</label><br/><input type="date" id="dob" required></div>
          <div>
            <label>роЪроирпНродро┐ро░ройрпН Degree</label><br/>
            <input type="number" id="moon_deg" min="0" max="359" step="1" required style="width:80px">┬░
            <input type="number" id="moon_min" min="0" max="59" step="1" required style="width:80px">' 
            <input type="number" id="moon_sec" min="0" max="59" step="1" required style="width:80px">"
          </div>
          <div>
            <label>ро▓роХрпНройроорпН Degree</label><br/>
            <input type="number" id="lagna_deg" min="0" max="359" step="1" style="width:80px">┬░
            <input type="number" id="lagna_min" min="0" max="59" step="1" style="width:80px">' 
            <input type="number" id="lagna_sec" min="0" max="59" step="1" style="width:80px">"
          </div>
          <div><label>роХрогро┐рокрпНрокрпБ родрпЗродро┐/роирпЗро░роорпН</label><br/><input type="datetime-local" id="caldate" style="width:210px"></div>
          <div><button class="btn" id="runBtn">роХрогроХрпНроХро┐роЯрпБ</button></div>
        </div>
      </div>

      <div class="card" id="planetButtons" style="display:none"></div>

      <div class="card">
        <div class="south-chart" id="rasiChart"></div>
        <div class="export-bar">
  <button id="savePngBtn" type="button" class="btn-save">ЁЯЦ╝я╕П PNG роЪрпЗрооро┐роХрпНроХ</button>
  <label style="font-size:.95em;">роЕро│ро╡рпБ:
    <select id="pngScale">
      <option value="1">1├Ч</option>
      <option value="2" selected>2├Ч</option>
      <option value="3">3├Ч</option>
    </select>
  </label>
  <label style="font-size:.95em;">рокроХрпБродро┐:
    <select id="pngTarget">
      <option value="rasiChart">роХроЯрпНроЯроорпН роороЯрпНроЯрпБроорпН</option>
      <option value="current">родро▒рпНрокрпЛродрпИроп роЪрпБро░рпБроХрпНроХроорпН</option>
      <option value="dasatree">родроЪрпИ рооро░роорпН</option>
      <option value="full">роорпБро┤рпБ рокроХрпНроХроорпН</option>
    </select>
  </label>
</div>
      </div>

      <div class="card" style="display:none" id="planetsTable">
        <table id="planetsDmsTable">
          <thead>
            <tr>
              <th>Planet</th>
              <th>Degrees (┬░ ' ")</th>
              <th>Nakshatra - Pada</th>
              <th>Rasi</th>
              <th>Rasi Owner</th>
              <th>Nakshatra Owner</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: legend + summaries + tree -->
    <div class="grid">
      <div class="card">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <span class="pill d"><span class="dot" style="background:#17671a"></span> родроЪрпИ</span>
          <span class="pill p"><span class="dot" style="background:#40be4a"></span> рокрпБроХрпНродро┐</span>
          <span class="pill a"><span class="dot" style="background:#b9f4ba;border:2px solid #21572a"></span> роЕроирпНродро░роорпН</span>
        </div>
        <div class="muted" style="margin:6px">ЁЯМЩ родроЪро╛ роЖро░роорпНрокроорпН роХро╛роЯрпНроЯрокрпНрокроЯрпБроорпН.</div>
      </div>

      <div class="currentbox" id="current"></div>
      <div class="card" id="currentSplits"></div>
      <div class="card" id="dasatree"></div>
      <div class="card" id="padasplit"></div>
    </div>
  </div>

<script>
/* ====================== THEME TOGGLE ====================== */
const themeBtn = document.getElementById('themeToggle');
themeBtn.addEventListener('click', ()=>{
  const next = document.body.getAttribute('data-theme') === 'dark' ? '' : 'dark';
  if(next) document.body.setAttribute('data-theme','dark'); else document.body.removeAttribute('data-theme');
});

/* ====================== CONSTANTS ====================== */
const PLANETS = ["роХрпЗродрпБ","роЪрпБроХрпНро░ройрпН","роЪрпВро░ро┐ропройрпН","роЪроирпНродро┐ро░ройрпН","роЪрпЖро╡рпНро╡ро╛ропрпН","ро░ро╛роХрпБ","роХрпБро░рпБ","роЪройро┐","рокрпБродройрпН"];
const DASA_YEARS = {"роХрпЗродрпБ":7,"роЪрпБроХрпНро░ройрпН":20,"роЪрпВро░ро┐ропройрпН":6,"роЪроирпНродро┐ро░ройрпН":10,"роЪрпЖро╡рпНро╡ро╛ропрпН":7,"ро░ро╛роХрпБ":18,"роХрпБро░рпБ":16,"роЪройро┐":19,"рокрпБродройрпН":17};
const NAKS = [
  {name:'роЕро╕рпНро╡ро┐ройро┐',lord:'роХрпЗродрпБ'},{name:'рокро░рогро┐',lord:'роЪрпБроХрпНро░ройрпН'},{name:'роХро┐ро░рпБродрпНродро┐роХрпИ',lord:'роЪрпВро░ро┐ропройрпН'},
  {name:'ро░рпЛро╣ро┐рогро┐',lord:'роЪроирпНродро┐ро░ройрпН'},{name:'рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН',lord:'роЪрпЖро╡рпНро╡ро╛ропрпН'},{name:'родро┐ро░рпБро╡ро╛родро┐ро░рпИ',lord:'ро░ро╛роХрпБ'},
  {name:'рокрпБройро░рпНрокрпВроЪроорпН',lord:'роХрпБро░рпБ'},{name:'рокрпВроЪроорпН',lord:'роЪройро┐'},{name:'роЖропро┐ро▓рпНропроорпН',lord:'рокрпБродройрпН'},
  {name:'роороХроорпН',lord:'роХрпЗродрпБ'},{name:'рокрпВро░роорпН',lord:'роЪрпБроХрпНро░ройрпН'},{name:'роЙродрпНродро┐ро░роорпН',lord:'роЪрпВро░ро┐ропройрпН'},
  {name:'ро╣ро╕рпНродроорпН',lord:'роЪроирпНродро┐ро░ройрпН'},{name:'роЪро┐родрпНродро┐ро░рпИ',lord:'роЪрпЖро╡рпНро╡ро╛ропрпН'},{name:'роЪрпБро╡ро╛родро┐',lord:'ро░ро╛роХрпБ'},
  {name:'ро╡ро┐роЪро╛роХроорпН',lord:'роХрпБро░рпБ'},{name:'роЕройрпБро╖роорпН',lord:'роЪройро┐'},{name:'роХрпЗроЯрпНроЯрпИ',lord:'рокрпБродройрпН'},
  {name:'роорпВро▓роорпН',lord:'роХрпЗродрпБ'},{name:'рокрпВро░ро╛роЯроорпН',lord:'роЪрпБроХрпНро░ройрпН'},{name:'роЙродрпНродро┐ро░ро╛роЯроорпН',lord:'роЪрпВро░ро┐ропройрпН'},
  {name:'родро┐ро░рпБро╡рпЛрогроорпН',lord:'роЪроирпНродро┐ро░ройрпН'},{name:'роЕро╡ро┐роЯрпНроЯроорпН',lord:'роЪрпЖро╡рпНро╡ро╛ропрпН'},{name:'роЪродропроорпН',lord:'ро░ро╛роХрпБ'},
  {name:'рокрпВро░роЯрпНроЯро╛родро┐',lord:'роХрпБро░рпБ'},{name:'роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐',lord:'роЪройро┐'},{name:'ро░рпЗро╡родро┐',lord:'рокрпБродройрпН'}
];
const rasiData=[
  { name: "роорпЗро╖роорпН", code: "r01", padas: ["роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 1","роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 2","роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 3","роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 4","рокро░рогро┐ - рокро╛родроорпН 1","рокро░рогро┐ - рокро╛родроорпН 2","рокро░рогро┐ - рокро╛родроорпН 3","рокро░рогро┐ - рокро╛родроорпН 4","роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 1"] },
  { name: "ро░ро┐ро╖рокроорпН", code: "r02", padas: ["роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 2","роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 3","роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 4","ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 1","ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 2","ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 3","ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 4","рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 1","рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 2"] },
  { name: "рооро┐родрпБройроорпН", code: "r03", padas: ["рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 3","рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 4","родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 1","родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 2","родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 3","родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 4","рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 1","рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 2","рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 3"] },
  { name: "роХроЯроХроорпН", code: "r04", padas: ["рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 4","рокрпВроЪроорпН - рокро╛родроорпН 1","рокрпВроЪроорпН - рокро╛родроорпН 2","рокрпВроЪроорпН - рокро╛родроорпН 3","рокрпВроЪроорпН - рокро╛родроорпН 4","роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 1","роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 2","роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 3","роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 4"] },
  { name: "роЪро┐роорпНроороорпН", code: "r05", padas: ["роороХроорпН - рокро╛родроорпН 1","роороХроорпН - рокро╛родроорпН 2","роороХроорпН - рокро╛родроорпН 3","роороХроорпН - рокро╛родроорпН 4","рокрпВро░роорпН - рокро╛родроорпН 1","рокрпВро░роорпН - рокро╛родроорпН 2","рокрпВро░роорпН - рокро╛родроорпН 3","рокрпВро░роорпН - рокро╛родроорпН 4","роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 1"] },
  { name: "роХройрпНройро┐", code: "r06", padas: ["роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 2","роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 3","роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 4","ро╣ро╕рпНродроорпН - рокро╛родроорпН 1","ро╣ро╕рпНродроорпН - рокро╛родроорпН 2","ро╣ро╕рпНродроорпН - рокро╛родроорпН 3","ро╣ро╕рпНродроорпН - рокро╛родроорпН 4","роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 1","роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 2"] },
  { name: "родрпБро▓ро╛роорпН", code: "r07", padas: ["роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 3","роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 4","роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 1","роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 2","роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 3","роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 4","ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 1","ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 2","ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 3"] },
  { name: "ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН", code: "r08", padas: ["ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 4","роЕройрпБро╖роорпН - рокро╛родроорпН 1","роЕройрпБро╖роорпН - рокро╛родроорпН 2","роЕройрпБро╖роорпН - рокро╛родроорпН 3","роЕройрпБро╖роорпН - рокро╛родроорпН 4","роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 1","роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 2","роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 3","роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 4"] },
  { name: "родройрпБроЪрпБ", code: "r09", padas: ["роорпВро▓роорпН - рокро╛родроорпН 1","роорпВро▓роорпН - рокро╛родроорпН 2","роорпВро▓роорпН - рокро╛родроорпН 3","роорпВро▓роорпН - рокро╛родроорпН 4","рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 1","рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 2","рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 3","рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 4","роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 1"] },
  { name: "роороХро░роорпН", code: "r10", padas: ["роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 2","роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 3","роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 4","родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 1","родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 2","родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 3","родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 4","роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 1","роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 2"] },
  { name: "роХрпБроорпНрокроорпН", code: "r11", padas: ["роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 3","роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 4","роЪродропроорпН - рокро╛родроорпН 1","роЪродропроорпН - рокро╛родроорпН 2","роЪродропроорпН - рокро╛родроорпН 3","роЪродропроорпН - рокро╛родроорпН 4","рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 1","рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 2","рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 3"] },
  { name: "роорпАройроорпН", code: "r12", padas: ["рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 4","роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 1","роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 2","роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 3","роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 4","ро░рпЗро╡родро┐ - рокро╛родроорпН 1","ро░рпЗро╡родро┐ - рокро╛родроорпН 2","ро░рпЗро╡родро┐ - рокро╛родроорпН 3","ро░рпЗро╡родро┐ - рокро╛родроорпН 4"] }
];
const rasisToReverse=["ро░ро┐ро╖рокроорпН","родрпБро▓ро╛роорпН","родройрпБроЪрпБ","роороХро░роорпН","роХрпБроорпНрокроорпН","роорпАройроорпН"];
let padaDomList=[];

/* ====================== HELPERS ====================== */
const LOCATIONIQ_TOKEN = 'pk.c1e392aaa38cf30cc350555c040477b5';
const FREE_ASTRO_API_KEY = 'PZVUMczZA7ahUT0ImRHbB4tHrB16Cyd69iU54vmK';
function debounce(fn, delay){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }
function decToDMS(dec){ const deg=Math.floor(dec); const minFloat=(dec-deg)*60; const min=Math.floor(minFloat); const sec=Math.round((minFloat-min)*60); return {deg,min,sec}; }
function addYears(date,years){ let d=new Date(date), y=Math.floor(years), m=(years-y)*12; d.setFullYear(d.getFullYear()+y); d.setMonth(d.getMonth()+Math.floor(m)); d.setDate(d.getDate()+Math.round((m-Math.floor(m))*30)); return d; }
function formatDate(dt){ return dt.toISOString().slice(0,10); }
function cycle9Nakshatras(start){ return Array(9).fill(0).map((_,j)=>(start+j)%27); }
function getLagnaPadaIndex(degree){ const d=((Number(degree)%360)+360)%360; const padaSizeDeg=360/108; return Math.floor(d/padaSizeDeg)+1; }
function getMoonPadaIndex(d,m,s){ const degree=Number(d)+Number(m)/60+Number(s)/3600; const NAK=13+20/60; const P=NAK/4; return Math.floor((degree%360)/P)+1; }

/* ====================== RASI GRID ====================== */
function drawChartGrid(){
  const chart = document.getElementById('rasiChart');
  chart.innerHTML='';
  padaDomList=[];
  let globalPadaCounter=1;
  rasiData.forEach((rasi,ri)=>{
    const isReversed=rasisToReverse.includes(rasi.name);
    const padas = isReversed ? rasi.padas.slice().reverse() : rasi.padas.slice();
    const box=document.createElement('div'); box.className=`box ${rasi.code}`; box.dataset.rasiIdx=ri+1;
    const title=document.createElement('div'); title.className='rasi-name'; title.textContent=rasi.name; box.appendChild(title);
    for(let j=0;j<9;j++){
      const line=document.createElement('div'); line.className='line'; line.textContent=padas[j]||'-';
      const globalIndex=isReversed? (globalPadaCounter+8-j): (globalPadaCounter+j);
      line.dataset.padaIndex=globalIndex;
      padaDomList[globalIndex]=line;
      box.appendChild(line);
    }
    globalPadaCounter+=9;
    chart.appendChild(box);
  });
}

/* ====================== DASA CALC ====================== */
function getDasaLordsAndNames(moon){
  const nakLen=13+20/60;
  const nakIdx=Math.floor(moon/nakLen);
  const startLord=NAKS[nakIdx].lord;
  const startIdx=PLANETS.indexOf(startLord);
  const dasaLords=PLANETS.slice(startIdx).concat(PLANETS.slice(0,startIdx));
  const dasaNakIdxs=Array(9).fill(0).map((_,j)=>(nakIdx+j)%27);
  const dasaNakNames=dasaNakIdxs.map(i=>NAKS[i].name);
  return {dasaLords,dasaNakIdxs,dasaNakNames,nakIdx};
}
function dasaTree(moon, dob, now){
  const nakLen=13+20/60;
  const {dasaLords,dasaNakIdxs,dasaNakNames,nakIdx}=getDasaLordsAndNames(moon);
  const offsetDeg=moon - nakIdx*nakLen;
  const balance=1 - (offsetDeg/nakLen);
  let mdStarts=[], cursor=addYears(dob, -(DASA_YEARS[dasaLords[0]]*(1-balance)));
  for(let i=0;i<9;i++){ mdStarts[i]=new Date(cursor); cursor=addYears(cursor, DASA_YEARS[dasaLords[i]]); }
  const arr=dasaLords.map((lord,i)=>({ index:i, lord, nak:dasaNakNames[i], nakIdx:dasaNakIdxs[i], start:mdStarts[i], end:mdStarts[i+1]||cursor, current: now>=mdStarts[i] && now<(mdStarts[i+1]||cursor), puthis: [] }));
  arr.forEach((md)=>{
    const pIdxs=cycle9Nakshatras(md.nakIdx); const pLords=pIdxs.map(i=>NAKS[i].lord); const pNames=pIdxs.map(i=>NAKS[i].name);
    const durationYears=(md.end-md.start)/(1000*60*60*24*365.2425);
    let antarStarts=[], c=new Date(md.start);
    for(let j=0;j<9;j++){ antarStarts[j]=new Date(c); const part=durationYears*(DASA_YEARS[pLords[j]]/120); c=addYears(c, part); }
    md.puthis=pLords.map((pl,pi)=>({ index:pi, lord:pl, nak:pNames[pi], nakIdx:pIdxs[pi], start:antarStarts[pi], end:antarStarts[pi+1]||c, current: now>=antarStarts[pi] && now<(antarStarts[pi+1]||c), antharas: [] }));
    md.puthis.forEach(pt=>{
      const aIdxs=cycle9Nakshatras(pt.nakIdx); const aLords=aIdxs.map(i=>NAKS[i].lord); const aNames=aIdxs.map(i=>NAKS[i].name);
      const dur=(pt.end-pt.start)/(1000*60*60*24*365.2425); let aStarts=[], cc=new Date(pt.start);
      for(let k=0;k<9;k++){ aStarts[k]=new Date(cc); const part=dur*(DASA_YEARS[aLords[k]]/120); cc=addYears(cc, part); }
      pt.antharas=aLords.map((al,ai)=>({ index:ai, lord:al, nak:aNames[ai], nakIdx:aIdxs[ai], start:aStarts[ai], end:aStarts[ai+1]||cc, current: now>=aStarts[ai] && now<(aStarts[ai+1]||cc) }));
    });
  });
  return arr;
}
function currentPadaSplit(period){
  if(!period) return [];
  const durYears=(period.end-period.start)/(1000*60*60*24*365.2425);
  const per=durYears/4; let arr=[], cur=new Date(period.start);
  for(let i=0;i<4;i++){ const to=addYears(cur,per); arr.push({nak:NAKS[period.nakIdx].name, pada:i+1, lord:NAKS[period.nakIdx].lord, start:new Date(cur), end:to}); cur=to; }
  return arr;
}
function findCurrentPath(tree){
  for(let i=0;i<tree.length;i++){ const md=tree[i]; if(md.current){ let dI=i,pI=-1,aI=-1; for(let j=0;j<md.puthis.length;j++){ const pt=md.puthis[j]; if(pt.current){ pI=j; for(let k=0;k<pt.antharas.length;k++){ if(pt.antharas[k].current){ aI=k; } } } } return {dasa:dI, puthi:pI, anth:aI}; } }
  return {dasa:-1, puthi:-1, anth:-1};
}
function getCurrentPada(period,now){
  if(!period) return {padaIdx:-1,pada:null,from:null,to:null,nak:null};
  const total=(period.end-period.start);
  for(let i=0;i<4;i++){
    const from=new Date(period.start.getTime()+ (total*i/4));
    const to=new Date(period.start.getTime()+ (total*(i+1)/4));
    if(now>=from && now<to){ return {padaIdx:i, pada:i+1, from, to, nak: NAKS[period.nakIdx].name}; }
  }
  return {padaIdx:-1,pada:null,nak:null};
}
function getDasaPercentage(period,now){ if(!period||!period.start||!period.end) return 0; const total=period.end-period.start; const elapsed=now - period.start; return Math.round(Math.min(Math.max(elapsed/total,0),1)*100); }

/* ====================== RENDERING ====================== */
let vimData, vimCurrentPath, openState={dasa:null, puthi:null, anthara:null};
function renderTree(arr,curr){
  function dUl(){ let h="<ul class='tree-ul'>"; arr.forEach((md,mi)=>{ const active=(curr.dasa===mi)?' tree-active':'';
    h+=`<li class="tree-li${active}">
      <button class="expand-btn${openState.dasa===mi?" expanded":""}" onclick="expandDasa(${mi});event.stopPropagation();">${openState.dasa===mi?"тЦ╛":"тЦ╕"}</button>
      <span class='tree-highlight-dasa' onclick="treeClickDasa(${mi});event.stopPropagation();">${md.lord} (${md.nak})</span>
      <span class="tree-period">${formatDate(md.start)} - ${formatDate(md.end)}</span>`;
    if(openState.dasa===mi) h+=pUl(md,mi);
    h+='</li>';}); h+='</ul>'; return h; }
  function pUl(md,mdi){ let h="<ul class='tree-ul'>"; md.puthis.forEach((pt,pi)=>{ const active=(curr.dasa===mdi && curr.puthi===pi)?' tree-active':'';
    h+=`<li class="tree-li${active}">
      <button class="expand-btn${openState.puthi===pi?" expanded":""}" onclick="expandPuthi(${pi});event.stopPropagation();">${openState.puthi===pi?"тЦ╛":"тЦ╕"}</button>
      <span class='tree-highlight-puthi' onclick="treeClickPuthi(${mdi},${pi});event.stopPropagation();">${pt.lord} (${pt.nak})</span>
      <span class="tree-period">${formatDate(pt.start)} - ${formatDate(pt.end)}</span>`;
    if(openState.puthi===pi) h+=aUl(pt,mdi,pi);
    h+='</li>';}); h+='</ul>'; return h; }
  function aUl(pt,mdi,pi){ let h="<ul class='tree-ul'>"; pt.antharas.forEach((at,ai)=>{ const active=(curr.dasa===mdi && curr.puthi===pi && curr.anth===ai)?' tree-active':'';
    h+=`<li class="tree-li${active}">
      <span class='tree-highlight-anthara' onclick="treeClickAnthara(${mdi},${pi},${ai});event.stopPropagation();">${at.lord} (${at.nak})</span>
      <span class="tree-period">${formatDate(at.start)} - ${formatDate(at.end)}</span></li>`;}); h+='</ul>'; return h; }
  document.getElementById('dasatree').innerHTML=dUl();
}
function renderSummary(md,mdPada,pt,ptPada,at,atPada){
  const now=document.getElementById('caldate').value? new Date(document.getElementById('caldate').value): new Date();
  const dPct=getDasaPercentage(md,now), pPct=getDasaPercentage(pt,now), aPct=getDasaPercentage(at,now);
  const html=`<div>
    <div style="margin-bottom:8px;"><span style="color:#17671a;font-weight:800">родроЪрпИ</span>: <b>${md?md.lord:'-'}</b> (${mdPada?.nak||''} - рокро╛родроорпН ${mdPada?.pada||'-'})<br/>
      <span class="dates">${mdPada?.from?formatDate(mdPada.from)+' - '+formatDate(mdPada.to):''}</span><br/><b>роорпБройрпНройрпЗро▒рпНро▒роорпН:</b> ${dPct}%</div>
    <div style="margin-bottom:8px;"><span style="color:#40be4a;font-weight:800">рокрпБроХрпНродро┐</span>: <b>${pt?pt.lord:'-'}</b> (${ptPada?.nak||''} - рокро╛родроорпН ${ptPada?.pada||'-'})<br/>
      <span class="dates">${ptPada?.from?formatDate(ptPada.from)+' - '+formatDate(ptPada.to):''}</span><br/><b>роорпБройрпНройрпЗро▒рпНро▒роорпН:</b> ${pPct}%</div>
    <div><span style="color:#3b8733;font-weight:800">роЕроирпНродро░роорпН</span>: <b>${at?at.lord:'-'}</b> (${atPada?.nak||''} - рокро╛родроорпН ${atPada?.pada||'-'})<br/>
      <span class="dates">${atPada?.from?formatDate(atPada.from)+' - '+formatDate(atPada.to):''}</span><br/><b>роорпБройрпНройрпЗро▒рпНро▒роорпН:</b> ${aPct}%</div>
  </div>`;
  document.getElementById('current').innerHTML=html;
}
function buildSplitBox(title,period){
  if(!period) return "";
  const splits=currentPadaSplit(period);
  return `<div style="margin:8px 0;">
    <b>${title} - ${period.nak} (${period.lord})</b><br/>
    ${splits.map(s=>`${s.nak} - рокро╛родроорпН ${s.pada} : <span class='dates'>${formatDate(s.start)} - ${formatDate(s.end)}</span>`).join("<br/>")}
  </div>`;
}
function renderAll(nowParam){
  clearHighlights();
  const now=nowParam||(document.getElementById('caldate').value? new Date(document.getElementById('caldate').value): new Date());
  const md=vimData?.[vimCurrentPath.dasa], pt=md?.puthis?.[vimCurrentPath.puthi], at=pt?.antharas?.[vimCurrentPath.anth];
  const mdPada=getCurrentPada(md,now), ptPada=getCurrentPada(pt,now), atPada=getCurrentPada(at,now);
  showCurrentDasaPadaHighlight();
  renderSummary(md,mdPada,pt,ptPada,at,atPada);
  renderTree(vimData,vimCurrentPath);
  document.getElementById('currentSplits').innerHTML = buildSplitBox("родроЪрпИ",md)+buildSplitBox("рокрпБроХрпНродро┐",pt)+buildSplitBox("роЕроирпНродро░роорпН",at);
  // Lagna-based Range3 auto
  const Ld=parseInt(lagna_deg.value)||0, Lm=parseInt(lagna_min.value)||0, Ls=parseInt(lagna_sec.value)||0;
  const totalDeg= Ld + Lm/60 + Ls/3600; const lagnaPada=getLagnaPadaIndex(totalDeg);
  highlightPadaRange3(lagnaPada);
  // Moon marker
  const globalPada=getMoonPadaIndex(Number(moon_deg.value),Number(moon_min.value),Number(moon_sec.value)); placeMoonSymbolToPada(globalPada);
}

/* ====================== HIGHLIGHTS ====================== */
function clearHighlights(){
  ['highlight-pada-dasa','highlight-pada-puthi','highlight-pada-anthara','clicked-pada-1'].forEach(cls=>{
    document.querySelectorAll('.'+cls).forEach(e=>e.classList.remove(cls));
  });
  for(let i=1;i<=12;i++){ document.querySelectorAll('.highlight-pada-'+i).forEach(e=>e.classList.remove('highlight-pada-'+i)); }
  document.querySelectorAll('.moon-pada-marker').forEach(e=>e.remove());
}
function showCurrentDasaPadaHighlight(){
  if(!vimData||!vimCurrentPath) return;
  let now=new Date(); const cal=document.getElementById('caldate'); if(cal&&cal.value) now=new Date(cal.value);
  const md=vimData[vimCurrentPath.dasa], pt=md?.puthis?.[vimCurrentPath.puthi], at=pt?.antharas?.[vimCurrentPath.anth];
  const mdPada=getCurrentPada(md,now), ptPada=getCurrentPada(pt,now), atPada=getCurrentPada(at,now);
  const idxD=(mdPada.pada? findPadaIndexByLabel(mdPada.nak, mdPada.pada): -1);
  const idxP=(ptPada.pada? findPadaIndexByLabel(ptPada.nak, ptPada.pada): -1);
  const idxA=(atPada.pada? findPadaIndexByLabel(atPada.nak, atPada.pada): -1);
  if(idxD>0) padaDomList[idxD].classList.add('highlight-pada-dasa');
  if(idxP>0) padaDomList[idxP].classList.add('highlight-pada-puthi');
  if(idxA>0) padaDomList[idxA].classList.add('highlight-pada-anthara');
}
function findPadaIndexByLabel(nakName,padaNum){
  nakName=String(nakName).trim(); const want='рокро╛родроорпН '+Number(padaNum);
  for(let i=1;i<=108;i++){ const t=padaDomList[i]?.textContent?.trim()||''; if(t.includes(nakName)&&t.includes(want)) return i; } return -1;
}
function highlightPadaRange3(p){
  for(let i=1;i<=12;i++){ document.querySelectorAll('.highlight-pada-'+i).forEach(e=>e.classList.remove('highlight-pada-'+i)); }
  document.querySelectorAll('.clicked-pada-1').forEach(e=>e.classList.remove('clicked-pada-1'));
  if(padaDomList[p]) padaDomList[p].classList.add('clicked-pada-1');
  const add=(off,cls)=>{ const idx=((p-1+off)%108)+1; if(padaDomList[idx]) padaDomList[idx].classList.add(cls); };
  for(let o=1;o<=8;o++) add(o,'highlight-pada-1');
  for(let o=9;o<=17;o++) add(o,'highlight-pada-2');
  for(let o=18;o<=26;o++) add(o,'highlight-pada-3');
  for(let o=27;o<=35;o++) add(o,'highlight-pada-4');
  for(let o=36;o<=44;o++) add(o,'highlight-pada-5');
  for(let o=45;o<=53;o++) add(o,'highlight-pada-6');
  for(let o=54;o<=62;o++) add(o,'highlight-pada-7');
  for(let o=63;o<=71;o++) add(o,'highlight-pada-8');
  for(let o=72;o<=80;o++) add(o,'highlight-pada-9');
  for(let o=81;o<=89;o++) add(o,'highlight-pada-10');
  for(let o=90;o<=98;o++) add(o,'highlight-pada-11');
  for(let o=99;o<=107;o++) add(o,'highlight-pada-12');
}
function placeMoonSymbolToPada(globalPada){
  const el=padaDomList[globalPada]; if(el){ el.insertAdjacentHTML('beforeend', `<span class="moon-pada-marker" style="font-size:1.2em;margin-left:6px">ЁЯМЩ</span>`); }
}

/* ====================== TREE CLICKS ====================== */
window.treeClickDasa=function(di){ clearHighlights(); const md=vimData[di]; const mdPada=getCurrentPada(md,new Date()); if(mdPada.pada){ const idx=findPadaIndexByLabel(mdPada.nak,mdPada.pada); if(idx>0) padaDomList[idx].classList.add('highlight-pada-dasa'); } };
window.treeClickPuthi=function(di,pi){ clearHighlights(); const pt=vimData[di].puthis[pi]; const ptPada=getCurrentPada(pt,new Date()); if(ptPada.pada){ const idx=findPadaIndexByLabel(ptPada.nak,ptPada.pada); if(idx>0) padaDomList[idx].classList.add('highlight-pada-puthi'); } };
window.treeClickAnthara=function(di,pi,ai){ clearHighlights(); const at=vimData[di].puthis[pi].antharas[ai]; const atPada=getCurrentPada(at,new Date()); if(atPada.pada){ const idx=findPadaIndexByLabel(atPada.nak,atPada.pada); if(idx>0) padaDomList[idx].classList.add('highlight-pada-anthara'); } };
window.expandDasa=function(idx){ openState.dasa=(openState.dasa===idx? null: idx); openState.puthi=null; openState.anthara=null; renderAll(); };
window.expandPuthi=function(idx){ openState.puthi=(openState.puthi===idx? null: idx); openState.anthara=null; renderAll(); };

/* ====================== PLANET LABELS ====================== */
function placePlanetsOnChart(planets){
  if(!planets||!padaDomList.length) return;
  // Clear existing planet labels
  for(let i=1;i<=108;i++){ const cell=padaDomList[i]; if(cell){ [...cell.querySelectorAll("[class^='planet-']")].forEach(el=>el.remove()); } }
  const planetCodes={ Ascendant:'ро▓', Sun:'роЪрпВ', Moon:'роЪроирпН', Mercury:'рокрпБ', Venus:'роЪрпБ', Mars:'роЪрпЖ', Jupiter:'роХрпБ', Saturn:'роЪ', Rahu:'ро░ро╛', Ketu:'роХрпЗ' };
  function getGlobalPada(decDeg){ const padaSizeDeg=360/108; return Math.floor((decDeg%360)/padaSizeDeg)+1; }
  Object.entries(planets).forEach(([key,obj])=>{ if(obj&&obj.fullDegree!=null){ const idx=getGlobalPada(obj.fullDegree); const cell=padaDomList[idx]; if(cell){ const span=document.createElement('span'); span.textContent=planetCodes[key]||key.slice(0,2); span.className=`planet-${key}`; span.style.cssText='font-size:.9em;margin-left:6px;color:#d22'; cell.appendChild(span);} } });
}

/* ====================== API: LOCATION + ASTRO ====================== */
const placeInput=document.getElementById('placeInput'); const suggestionsBox=document.getElementById('suggestions-box');
let selectedLat=null, selectedLon=null;
async function fetchPlaceSuggestions(q){
  if(!q||q.length<3) return [];
  try{ const res=await fetch(`https://us1.locationiq.com/v1/autocomplete.php?key=${LOCATIONIQ_TOKEN}&q=${encodeURIComponent(q)}&limit=5&format=json`);
       if(!res.ok) throw new Error('LocationIQ API error'); return await res.json(); } catch(e){ return []; }
}
placeInput.addEventListener('input', debounce(async()=>{
  const q=placeInput.value.trim();
  if(!q){ suggestionsBox.innerHTML=''; suggestionsBox.style.display='none'; selectedLat=selectedLon=null; return; }
  const places=await fetchPlaceSuggestions(q);
  if(places.length===0){ suggestionsBox.innerHTML=''; suggestionsBox.style.display='none'; selectedLat=selectedLon=null; return; }
  suggestionsBox.innerHTML='';
  places.forEach(place=>{ const d=document.createElement('div'); d.textContent=place.display_name; d.onclick=()=>{ placeInput.value=place.display_name; selectedLat=parseFloat(place.lat); selectedLon=parseFloat(place.lon); suggestionsBox.style.display='none';}; suggestionsBox.appendChild(d); });
  suggestionsBox.style.display='block';
},250));
document.addEventListener('click', e=>{ if(e.target!==placeInput && !suggestionsBox.contains(e.target)) suggestionsBox.style.display='none';});

const astroForm=document.getElementById('astroForm');
astroForm.addEventListener('submit', async(e)=>{
  e.preventDefault();
  if(!selectedLat||!selectedLon){ document.getElementById('apiResult').textContent='родропро╡рпБроЪрпЖропрпНродрпБ роЗроЯроорпН родрпЖро░ро┐ро╡рпБроЪрпЖропрпНропро╡рпБроорпН!'; return; }
  const dob=document.getElementById('dob_api').value; const tob=document.getElementById('tob_api').value;
  if(!dob||!tob){ document.getElementById('apiResult').textContent='родрпЗродро┐/роирпЗро░роорпН рокрпВро░рпНродрпНродро┐ роЪрпЖропрпНропро╡рпБроорпН!'; return; }
  document.getElementById('apiResult').textContent='роХрогроХрпНроХро┐роЯрпБроХро┐ро▒родрпБтАж';
  const [year,month,day]=dob.split('-').map(Number); const [hours,minutes]=tob.split(':').map(Number);
  const payload={ year,month,date:day,hours,minutes,seconds:0, latitude:selectedLat,longitude:selectedLon, timezone:5.5, settings:{observation_point:'geocentric', ayanamsha:'lahiri', language:'ta'} };
  try{
    const res=await fetch('https://json.freeastrologyapi.com/planets/extended',{ method:'POST', headers:{'Content-Type':'application/json','x-api-key':FREE_ASTRO_API_KEY}, body:JSON.stringify(payload)});
    if(!res.ok) throw new Error('API error '+res.status);
    const data=await res.json();
    if(!data.output){ document.getElementById('apiResult').textContent='API response missing planet data.'; return; }
    const planets=data.output;
    window.savedPlanetsForChart=planets;
    // DMS fill for Moon & Lagna
    if(planets.Moon&&planets.Ascendant){ const m=decToDMS(planets.Moon.fullDegree); const a=decToDMS(planets.Ascendant.fullDegree);
      moon_deg.value=m.deg; moon_min.value=m.min; moon_sec.value=m.sec; lagna_deg.value=a.deg; lagna_min.value=a.min; lagna_sec.value=a.sec; dob.value=dob; }
    // store simple map
    window.planetDegrees={}; Object.keys(planets).forEach(k=>{ if(typeof planets[k].fullDegree==='number'){ window.planetDegrees[k]=planets[k].fullDegree; } });
    ensurePlanetButtons();
    // populate table
    const tableWrap=document.getElementById('planetsTable'); tableWrap.style.display='block';
    const tbody=document.querySelector('#planetsDmsTable tbody'); tbody.innerHTML='';
    const order=['Ascendant','Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Rahu','Ketu'];
    const rasiList=["роорпЗро╖роорпН","ро░ро┐ро╖рокроорпН","рооро┐родрпБройроорпН","роХроЯроХроорпН","роЪро┐роорпНроороорпН","роХройрпНройро┐","родрпБро▓ро╛роорпН","ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН","родройрпБроЪрпБ","роороХро░роорпН","роХрпБроорпНрокроорпН","роорпАройроорпН"];
    const rasiOwners={"роорпЗро╖роорпН":"роЪрпЖро╡рпНро╡ро╛ропрпН","ро░ро┐ро╖рокроорпН":"роЪрпБроХрпНро░ройрпН","рооро┐родрпБройроорпН":"рокрпБродройрпН","роХроЯроХроорпН":"роЪроирпНродро┐ро░ройрпН","роЪро┐роорпНроороорпН":"роЪрпВро░ро┐ропройрпН","роХройрпНройро┐":"рокрпБродройрпН","родрпБро▓ро╛роорпН":"роЪрпБроХрпНро░ройрпН","ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН":"роЪрпЖро╡рпНро╡ро╛ропрпН","родройрпБроЪрпБ":"роХрпБро░рпБ","роороХро░роорпН":"роЪройро┐","роХрпБроорпНрокроорпН":"роЪройро┐","роорпАройроорпН":"роХрпБро░рпБ"};
    const nakLen=13+20/60;
    order.forEach(key=>{
      if(planets[key]&&typeof planets[key].fullDegree==='number'){
        const {deg,min,sec}=decToDMS(planets[key].fullDegree); const totalDeg=planets[key].fullDegree%360; const nakIdx=Math.floor(totalDeg/nakLen);
        const nakName=NAKS[nakIdx]?.name||'-'; const pada=Math.floor((totalDeg%nakLen)/(nakLen/4))+1; const rasiIndex=Math.floor(totalDeg/30);
        const rasiName=rasiList[rasiIndex]||'-'; const rasiOwner=rasiOwners[rasiName]||'-'; const nakOwner=NAKS[nakIdx]?.lord||'-';
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${key}</td><td>${deg}┬░ ${min}' ${sec}"</td><td>${nakName} - рокро╛родроорпН ${pada}</td><td>${rasiName}</td><td>${rasiOwner}</td><td>${nakOwner}</td>`; tbody.appendChild(tr);
      }
    });
    drawChartGrid(); placePlanetsOnChart(window.savedPlanetsForChart);
    document.getElementById('apiResult').textContent='API planet data рокрпЖро▒рокрпНрокроЯрпНроЯродрпБ! роЪроирпНродро┐ро░ройрпН/ро▓роХрпНроХро┐ройроорпН auto-filled.';
  }catch(err){ document.getElementById('apiResult').textContent='Error: '+err.message; }
});

function ensurePlanetButtons(){
  const container=document.getElementById('planetButtons');
  container.innerHTML='';
  if(!window.planetDegrees) return;
  Object.keys(window.planetDegrees).forEach(planet=>{
    const btn=document.createElement('button');
    btn.className='btn'; btn.style.margin='4px'; btn.style.background='transparent'; btn.style.border='1.5px solid var(--ring)'; btn.style.color='var(--ink)';
    btn.textContent=planet; btn.onclick=()=>showDasaForPlanet(planet); container.appendChild(btn);
  });
  container.style.display='block';
}
function showDasaForPlanet(planetName){
  const deg=window.planetDegrees?.[planetName];
  if(deg==null){ alert(`No degree for ${planetName}`); return; }
  const d=Math.floor(deg), mFloat=(deg-d)*60, m=Math.floor(mFloat), s=Math.round((mFloat-m)*60);
  moon_deg.value=d; moon_min.value=m; moon_sec.value=s; run();
}
(function(){
  const btn = document.getElementById('savePngBtn');
  if(!btn) return;

  async function ensureHtml2Canvas(){
    if (window.html2canvas) return window.html2canvas;
    await new Promise((resolve, reject)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      s.referrerPolicy = 'no-referrer'; // helps with some CORS cases
      s.onload=()=>resolve();
      s.onerror=()=>reject(new Error('html2canvas load failed'));
      document.head.appendChild(s);
    });
    return window.html2canvas;
  }

  function pickNode(targetSel){
    if (targetSel === 'full') return document.body;
    const el = document.getElementById(targetSel);
    if(!el) alert('Target not found: '+targetSel);
    return el;
  }

  btn.addEventListener('click', async ()=>{
    try{
      const h2c = await ensureHtml2Canvas();
      const targetSel = (document.getElementById('pngTarget')?.value) || 'rasiChart';
      const scale = Number(document.getElementById('pngScale')?.value) || 2;
      const node = pickNode(targetSel);
      if(!node) return;

      // temporarily ensure opaque white bg so PNG looks clean
      const prevBg = node.style.backgroundColor;
      node.style.backgroundColor = getComputedStyle(document.body).backgroundColor || '#ffffff';

      const canvas = await h2c(node, {
        scale, useCORS:true, backgroundColor:'#ffffff', logging:false, windowWidth: document.documentElement.scrollWidth
      });

      node.style.backgroundColor = prevBg;

      const link = document.createElement('a');
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      link.download = `JpsAstro-${targetSel}-${ts}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }catch(err){
      console.error(err);
      alert('PNG export failed: ' + err.message);
    }
  });
})();
/* ====================== RUN ====================== */
document.getElementById('runBtn').addEventListener('click', (e)=>{ e.preventDefault(); run(); });
function run(){
  const dobStr=document.getElementById('dob').value;
  const mdeg=parseInt(document.getElementById('moon_deg').value)||0;
  const mmin=parseInt(document.getElementById('moon_min').value)||0;
  const msec=parseInt(document.getElementById('moon_sec').value)||0;
  const moon=mdeg + mmin/60 + msec/3600;
  if(isNaN(moon)||moon<0||moon>=360){ alert('роЪроирпНродро┐ро░ройрпН роирпАро│роорпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.'); return; }
  const dob=new Date(dobStr); if(isNaN(dob.getTime())){ alert('рокро┐ро▒роирпНрод родрпЗродро┐ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.'); return; }
  const caldateStr=document.getElementById('caldate').value; const now=caldateStr? new Date(caldateStr): new Date();
  vimData=dasaTree(moon, dob, now); vimCurrentPath=findCurrentPath(vimData);
  drawChartGrid(); if(window.savedPlanetsForChart) placePlanetsOnChart(window.savedPlanetsForChart);
  openState={dasa:vimCurrentPath.dasa, puthi:vimCurrentPath.puthi, anthara:vimCurrentPath.anth};
  renderAll(now);
}

// initial grid
drawChartGrid();
</script>
</body>
</html>

